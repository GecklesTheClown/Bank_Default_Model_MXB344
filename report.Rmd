---
title: "Report"
author: "TBD"
date: "`r Sys.Date()`"
output: html_document
---

# Part 1 : Fixed Effects Model

This chunk is to refresh R studio and library the required packages.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("./scripts/setup.r")

all_loan_data <- read.csv(file = here::here('datasets', 'all_loan_data.csv')) # Load in the loan data
app_cov <- c("loan_amnt","term","int_rate","emp_length","home_ownership","annual_inc","verification_status","purpose","repay_fail")
all_loan_data <- all_loan_data[,app_cov]
all_cat_var <- c("repay_fail",
                 "term",
                 "emp_length",
                 "home_ownership", 
                 "verification_status", 
                 "purpose")

all_loan_data[,all_cat_var] <- lapply(all_loan_data[all_cat_var], factor)
lapply(all_loan_data[all_cat_var],levels) # Make all categorical variables into factors for R 
```

Now the initial loan data will be loaded into R.


Since this model is made to predict the chance of a given customer defaulting at the time of application. Many variables are not applicable. These include:

-   "credit_age_yrs"
-   "delinq_2yrs"
-   "dti"
-   "inq_last_6mths"
-   "last_pymnt_amnt"
-   "pub_rec"
-   "open_acc"
-   "total_acc"
-   "total_rec_int"
-   "total_rec_prncp"
-   "revol_bal"
-   "revol_util"

Thus removing these covariates leaves us with 5 categorical variables and 3 continuous variables.

- 
## Data Exploration

Let's take a look at the data.

```{r sum, include=TRUE}
summary(all_loan_data) # Summary of data
```

Now we are going to make our categorical variables into proportions 

```{r}
source(here("scripts","prop_data.r"))
```

Plot these 

```{r}
graph_pempfail; graph_logpempfail ; graph_ptermfail ; graph_logptermfail ; graph_phomefail ; graph_logphomefail 

```



```{r explore, include=TRUE}
### Make plots for the 3 continuous variables vs repay failure and plots for colinearity

RepayFail_labels <- c("0","1") # Make labels for the box plots with repay failur of the x-axis

#Box plot for loan_amount vs repay_fail
ploanamount <- ggplot(data = all_loan_data,
                      mapping = aes(
                                   x = factor(repay_fail),
                                   y = loan_amnt,
       )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Loan_amount")
ploanamount

#Box plot for int_rate vs repay_fail
pinterestrate <- ggplot(data = all_loan_data,
       mapping = aes(
         x = factor(repay_fail),
         y = int_rate,
       )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Int_rate")
pinterestrate 

#Box plot for annual_inc vs repay_fail
pannualincome <- ggplot(data = all_loan_data,
       mapping = aes(
         x = factor(repay_fail),
         y = annual_inc,
       )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Annual_inc")
pannualincome

# Test for colinarity 
cortest <- ggpairs(all_loan_data, columns = c(1, 3, 6))
cortest
```





## Model Selection

```{r}
#Initialize the Models

m.full.1w.log <- glm(data = all_loan_data,
                     formula = repay_fail ~.,
                     family = binomial(link = "logit"))
                
  
m.full.1w.pro <- glm(data = all_loan_data,
                     formula = repay_fail ~.,
                     family = binomial(link = "probit"))

m.full.1w.clog <- glm(data = all_loan_data,
                     formula = repay_fail ~.,
                     family = binomial(link = "cloglog"))

#Stepwise Regression


m.step.both.1w.log <- step(m.full.1w.log, direction = "both", trace = 0)
m.step.both.1w.pro <- step(m.full.1w.pro, direction = "both", trace = 0)
m.step.both.1w.clog <- step(m.full.1w.clog, direction = "both", trace = 0)

models <- c(m.step.both.1w.log,m.step.both.1w.pro,m.step.both.1w.clog)

model.list <- list(
  "log" = m.step.both.1w.log,
  "pro" = m.step.both.1w.pro,
  "cloglog" = m.step.both.1w.clog)

bics <- sapply(model.list,FUN = BIC)

plot_data <- 
  data.frame(
    model = c("log","pro","cloglog"),
    bic = bics)

#Display table with measures:
knitr::kable(plot_data,row.names = FALSE,
             col.names = c("Model","BIC"))


```
Our Probit came out the best


```{r}
m.initial <- m.full.1w.pro


anova(m.initial, test="Chisq")
pchisq(m.initial$deviance, df=m.initial$df.residual, lower.tail=FALSE)
res.initial = simulateResiduals(m.initial)
plot(res.initial)

pred <- predict(m.initial)
pred <- exp(pred)/(1+exp(pred))
plot(all_loan_data$repay_fail,pred,ylim=c(0,1.1),
xlim=c(0,1.1),ylab=
"Predicted"
,xlab=
"Observed")
points(c(0,2),c(0,2),type=
"l")
```


# Part 2: Mixed Effects Model

```{r data, include=TRUE}
ext_loan_data <- read.csv(file = here::here('datasets', 'extended_loan_data.csv'))  # Load in the extended loan data with time and regions
```

```{r exploreext data set issue_d, include=TRUE}
## Plot the proportion and log proportion of failure for issue_d

# Obtain number of people in each issue_d
issuedsum <- count(ext_loan_data, issue_d, .drop = FALSE)

# Obtain number of people that failed in each issue_d
ext_issued_fail <- count(ext_loan_data, issue_d, repay_fail == "1")
ext_missingrowIF <- c("Jun-2007", "TRUE", "0")
ext_issued_fail <- rbind(ext_issued_fail, ext_missingrowIF)
ext_issued_fail <- t(ext_issued_fail)
ext_issued_fail <- as.data.frame(ext_issued_fail)
ext_issued_fail <- relocate(ext_issued_fail, V110, .after = V55)
ext_issued_fail <- t(ext_issued_fail)
ext_issued_fail <- as.data.frame(ext_issued_fail)
ext_issued_fail$`repay_fail == "1"` <- as.logical(ext_issued_fail$`repay_fail == "1"`)
ext_issued_fail$n <- as.numeric(ext_issued_fail$n)
issuedfailsumext <- filter(ext_issued_fail, ext_issued_fail$`repay_fail == "1"` == "TRUE")

# Obtain proportion and log(proportion) of failure in each issue_d
prop_issue_d <- issuedfailsumext[,3] / issuedsum[,2]

# Obtain proportion and log(proportion) of failure in each issue_d
prop_issue_d_log <- sapply(prop_issue_d, log)
propissueddf <- data.frame(issue_d = issuedsum$issue_d, frequency = prop_issue_d, log_frequency = prop_issue_d_log )

pissuedfail <- ggplot(propissueddf, aes(x=issue_d, y=frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = propissueddf$issue_d) +
  labs(x = "issue_d",y = "Repay Failure Proportion") 

logpissuedfail <- ggplot(propissueddf, aes(x=issue_d, y=log_frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = propissueddf$issue_d) +
  labs(x = "issue_d",y = "Repay Failure Log(Proportion)") 

pissuedfail ; logpissuedfail
```

```{r exploreext data set zip_code, include=TRUE}
## Plot the proportion and log proportion of failure for zip_code

# Obtain number of people in each zip_code
zipcsum <- count(ext_loan_data, zip_code, .drop = FALSE)
# Obtain number of people that failed in each zip_code
ext_zipc_fail <- count(ext_loan_data, zip_code, repay_fail == "1", .drop = FALSE)
ext_zipc_fail <- filter(ext_zipc_fail, ext_zipc_fail$`repay_fail == "1"` == "FALSE")

# Obtain proportion and log(proportion) of failure in each zip_code
prop_zip_code <- zipcfailsumext[,2] / zipcsum[,2]

# Obtain proportion and log(proportion) of failure in each zip_code
prop_zip_code_log <- sapply(prop_zip_code, log)
propzipcdf <- data.frame(zip_code = zipcsum$zip_code, frequency = prop_zip_code, log_frequency = prop_zip_code_log )

pzipcfail <- ggplot(propzipcdf, aes(x=zip_code, y=frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = propzipcdf$zip_code) +
  labs(x = "zip_code",y = "Repay Failure Proportion") 

logpzipcfail <- ggplot(propzipcdf, aes(x=zip_code, y=log_frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = propzipcdf$zip_code) +
  labs(x = "zip_code",y = "Repay Failure Log(Proportion)") 

pzipcfail ; logpzipcfail
```

```{r exploreext data set addr_state, include=TRUE}
## Plot the proportion and log proportion of failure for addr_state

# Obtain number of people in each addr_state
addssum <- count(ext_loan_data, addr_state, .drop = FALSE)

# Obtain number of people that failed in each addr_state
ext_adds_fail <- count(ext_loan_data, addr_state, repay_fail == "1")
ext_missingrowAF <- c("ME", "TRUE", "0")
ext_adds_fail <- rbind(ext_adds_fail, ext_missingrowAF)
ext_adds_fail <- t(ext_adds_fail)
ext_adds_fail <- as.data.frame(ext_adds_fail)
ext_adds_fail <- relocate(ext_adds_fail, V100, .after = V43)
ext_adds_fail <- t(ext_adds_fail)
ext_adds_fail <- as.data.frame(ext_adds_fail)
ext_adds_fail$`repay_fail == "1"` <- as.logical(ext_adds_fail$`repay_fail == "1"`)
ext_adds_fail$n <- as.numeric(ext_adds_fail$n)
addsfailsumext <- filter(ext_adds_fail, ext_adds_fail$`repay_fail == "1"` == "TRUE")

# Obtain proportion and log(proportion) of failure in each addr_state
prop_addr_state <- addsfailsumext[,3] / addssum[,2]

# Obtain proportion and log(proportion) of failure in each addr_state
prop_addr_state_log <- sapply(prop_addr_state, log)
propaddsdf <- data.frame(addr_state = addssum$addr_state, frequency = prop_addr_state, log_frequency = prop_addr_state_log )

paddsfail <- ggplot(propaddsdf, aes(x=addr_state, y=frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = propaddsdf$addr_state) +
  labs(x = "addr_state",y = "Repay Failure Proportion") 

logpaddsfail <- ggplot(propaddsdf, aes(x=addr_state, y=log_frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = propaddsdf$addr_state) +
  labs(x = "addr_state",y = "Repay Failure Log(Proportion)") 

paddsfail ; logpaddsfail
```
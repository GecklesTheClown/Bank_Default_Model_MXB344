---
title: "Report"
author: "TBD"
date: "`r Sys.Date()`"
output: html_document
---

## Standard Model 

This chunk is to refresh R studio and library the required packages.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("./scripts/setup.r")
```

Now the initial loan data will be loaded into R.

```{r data, include=TRUE}
all_loan_data <- read.csv(file = here::here('datasets', 'all_loan_data.csv')) # Load in the loan data
ext_loan_data <- read.csv(file = here::here('datasets', 'extended_loan_data.csv'))  # Load in the extended loan data with time and regions
```

Since this model is made to predict the chance of a given customer defaulting at the time of application. Many variables are not applicable. These include:

-   "credit_age_yrs"
-   "delinq_2yrs"
-   "dti"
-   "inq_last_6mths"
-   "last_pymnt_amnt"
-   "pub_rec"
-   "open_acc"
-   "total_acc"
-   "total_rec_int"
-   "total_rec_prncp"
-   "revol_bal"
-   "revol_util"

Thus removing these covariates leaves us with 5 categorical variables and 3 continuous variables.

- 

```{r}
app_cov <- c("loan_amnt","term","int_rate","emp_length","home_ownership","annual_inc","verification_status","purpose","repay_fail")
all_loan_data <- all_loan_data[,app_cov]
all_cat_var <- c("repay_fail",
                 "term",
                 "emp_length",
                 "home_ownership", 
                 "verification_status", 
                 "purpose")

all_loan_data[,all_cat_var] <- lapply(all_loan_data[all_cat_var], factor)
lapply(all_loan_data[all_cat_var],levels) # Make all categorical variables into factors for R 
```


```{r}
m.initial <- glm(repay_fail ~. , family = binomial, data = all_loan_data)

test <- glm(repay_fail ~1 , family = binomial, data = all_loan_data, trace = FALSE)

m.step.both.1w <- step(m.initial, direction = "backward", trace = 0)

res = simulateResiduals(m.step.both.1w)
plot(res)


```

Let's take a look at the data.

```{r sum, include=TRUE}
summary(all_loan_data) # Summary of data
```

Now we are going to make our categorical variables into proportions 

```{r}
source(here("scripts","prop_data.r"))
```

Plot these 

```{r}
graph_pempfail; graph_logpempfail ; graph_ptermfail ; graph_logptermfail ; graph_phomefail ; graph_logphomefail 

```



```{r explore, include=TRUE}
### Make plots for the 3 continuous variables vs repay failure and plots for colinearity

RepayFail_labels <- c("0","1") # Make labels for the box plots with repay failur of the x-axis

#Box plot for loan_amount vs repay_fail
ploanamount <- ggplot(data = all_loan_data,
                      mapping = aes(
                                   x = factor(repay_fail),
                                   y = loan_amnt,
       )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Loan_amount")
ploanamount

#Box plot for int_rate vs repay_fail
pinterestrate <- ggplot(data = all_loan_data,
       mapping = aes(
         x = factor(repay_fail),
         y = int_rate,
       )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Int_rate")
pinterestrate 

#Box plot for annual_inc vs repay_fail
pannualincome <- ggplot(data = all_loan_data,
       mapping = aes(
         x = factor(repay_fail),
         y = annual_inc,
       )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Annual_inc")
pannualincome

# Test for colinarity 
cortest <- ggpairs(all_loan_data, columns = c(1, 3, 6))
cortest
```


 ## Extended Model 
```{r exploreext data set 5 catagorical variables, include=TRUE}
## term

# Obtain number of people in each term
exttermsum <- count(ext_loan_data, term)

# Obtain number of people that failed in each term
ext_loan_data_fail <- filter(ext_loan_data, repay_fail == "1")
exttermfailsum <- count(ext_loan_data_fail, term)

# Obtain proportion and log(proportion) of failure in each term
extprop_term <- exttermfailsum[,2] / exttermsum[,2]
extprop_term_log <- log(extprop_term)

# Obtain proportion and log(proportion) of failure in each term
extproptermdf <- data.frame(term = exttermsum$term, frequency = extprop_term, log_frequency = extprop_term_log)

# Graph for ext term
graph_extptermfail <- ggplot(extproptermdf, aes(x=term, y=frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = extproptermdf$term) +
  labs(x = "term",y = "Repay Failure Proportion") +
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0))

graph_extlogptermfail <- ggplot(extproptermdf, aes(x=term, y=log_frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = extproptermdf$term) +
  labs(x = "term",y = "Repay Failure Log(Proportion)") +
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0))

graph_extptermfail ; graph_extlogptermfail

## Emp_length

# Obtain number of people in each emp_length
extempsum <- count(ext_loan_data, emp_length)

# Obtain number of people that failed in each emp_length
ext_loan_data_fail <- filter(ext_loan_data, repay_fail == "1")
extempfailsum <- count(ext_loan_data_fail, emp_length)

# Obtain proportion and log(proportion) of failure in each emp_length
extprop_emp_length <- extempfailsum[,2] / extempsum[,2]
extprop_emp_length_log <- log(extprop_emp_length)

# Obtain proportion and log(proportion) of failure in each emp_length
extpropempdf <- data.frame(emp_length = extempsum$emp_length, frequency = extprop_emp_length, log_frequency = extprop_emp_length_log)

# Graph for ext emp_length
graph_extpempfail <- ggplot(extpropempdf, aes(x=emp_length, y=frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = extpropempdf$emp_length) +
  labs(x = "Emp_Length",y = "Repay Failure Proportion") +
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0))

graph_extlogpempfail <- ggplot(extpropempdf, aes(x=emp_length, y=log_frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = extpropempdf$emp_length) +
  labs(x = "Emp_length",y = "Repay Failure Log(Proportion)") +
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0))

graph_extpempfail ; graph_extlogpempfail

## home_ownership

# Obtain number of people in each home_ownership
exthomesum <- count(ext_loan_data, home_ownership)

# Obtain number of people that failed in each home_ownership
ext_loan_data_fail <- filter(ext_loan_data, repay_fail == "1")
exthomefailsum <- count(ext_loan_data_fail, home_ownership)

# Obtain proportion and log(proportion) of failure in each home_ownership
extprop_home_ownership <- exthomefailsum[,2] / exthomesum[,2]
extprop_home_ownership_log <- log(extprop_home_ownership)

# Obtain proportion and log(proportion) of failure in each home_ownership
extprophomedf <- data.frame(home_ownership = exthomesum$home_ownership, frequency = extprop_home_ownership, log_frequency = extprop_home_ownership_log)

# Graph for ext home_ownership
graph_extphomefail <- ggplot(extprophomedf, aes(x=home_ownership, y=frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = extprophomedf$home_ownership) +
  labs(x = "home_ownership",y = "Repay Failure Proportion") +
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0))

graph_extlogphomefail <- ggplot(extprophomedf, aes(x=home_ownership, y=log_frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = extprophomedf$home_ownership) +
  labs(x = "home_ownership",y = "Repay Failure Log(Proportion)") +
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0))

graph_extphomefail ; graph_extlogphomefail

## verification_status

# Obtain number of people in each verification_status
extverisum <- count(ext_loan_data, verification_status)

# Obtain number of people that failed in each verification_status
ext_loan_data_fail <- filter(ext_loan_data, repay_fail == "1")
extverifailsum <- count(ext_loan_data_fail, verification_status)

# Obtain proportion and log(proportion) of failure in each verification_status
extprop_verification_status <- extverifailsum[,2] / extverisum[,2]
extprop_verification_status_log <- log(extprop_verification_status)

# Obtain proportion and log(proportion) of failure in each verification_status
extpropveridf <- data.frame(verification_status = extverisum$verification_status, frequency = extprop_verification_status, log_frequency = extprop_verification_status_log)

# Graph for ext verification_status
graph_extpverifail <- ggplot(extpropveridf, aes(x=verification_status, y=frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = extpropveridf$verification_status) +
  labs(x = "verification_status",y = "Repay Failure Proportion") +
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0))

graph_extlogpverifail <- ggplot(extpropveridf, aes(x=verification_status, y=log_frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = extpropveridf$verification_status) +
  labs(x = "verification_status",y = "Repay Failure Log(Proportion)") +
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0))

graph_extpverifail ; graph_extlogpverifail

## purpose

# Obtain number of people in each purpose
extpurpsum <- count(ext_loan_data, purpose)

# Obtain number of people that failed in each purpose
ext_loan_data_fail <- filter(ext_loan_data, repay_fail == "1")
extpurpfailsum <- count(ext_loan_data_fail, purpose)

# Obtain proportion and log(proportion) of failure in each purpose
extprop_purpose <- extpurpfailsum[,2] / extpurpsum[,2]
extprop_purpose_log <- log(extprop_purpose)

# Obtain proportion and log(proportion) of failure in each purpose
extproppurpdf <- data.frame(purpose = extpurpsum$purpose, frequency = extprop_purpose, log_frequency = extprop_purpose_log)

# Graph for ext purpose
graph_extppurpfail <- ggplot(extproppurpdf, aes(x=purpose, y=frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = extproppurpdf$purpose) +
  labs(x = "purpose",y = "Repay Failure Proportion") +
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0))

graph_extlogppurpfail <- ggplot(extproppurpdf, aes(x=purpose, y=log_frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = extproppurpdf$purpose) +
  labs(x = "purpose",y = "Repay Failure Log(Proportion)") +
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0))

graph_extppurpfail ; graph_extlogppurpfail
```

```{r exploreext data set 3 continous variables, include=TRUE}
### Make plots for the 3 continuous variables vs repay failure and plots for colinearity in the extended data set (since there are extra observations)

RepayFail_labels <- c("0","1") # Make labels for the box plots with repay failure of the x-axis

#Box plot for loan_amount vs repay_fail for extended data set
pextloanamount <- ggplot(data = ext_loan_data,
                         mapping = aes(
                           x = factor(repay_fail),
                           y = loan_amnt,
                         )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Loan_amount")
pextloanamount

#Box plot for int_rate vs repay_fail
pextinterestrate <- ggplot(data = ext_loan_data,
                        mapping = aes(
                          x = factor(repay_fail),
                          y = int_rate,
                        )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Int_rate")
pextinterestrate 

#Box plot for annual_inc vs repay_fail
pextannualincome <- ggplot(data = ext_loan_data,
                        mapping = aes(
                          x = factor(repay_fail),
                          y = annual_inc,
                        )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Annual_inc")
pextannualincome

# Test for colinarity 
cortest <- ggpairs(ext_loan_data, columns = c(2, 4, 7))
cortest
```

```{r exploreext data set issue_d, include=TRUE}
## Plot the proportion and log proportion of failure for issue_d

# Obtain number of people in each issue_d
issuedsum <- count(ext_loan_data, issue_d, .drop = FALSE)

# Obtain number of people that failed in each issue_d
ext_issued_fail <- count(ext_loan_data, issue_d, repay_fail == "1")
ext_missingrowIF <- c("Jun-2007", "TRUE", "0")
ext_issued_fail <- rbind(ext_issued_fail, ext_missingrowIF)
ext_issued_fail <- t(ext_issued_fail)
ext_issued_fail <- as.data.frame(ext_issued_fail)
ext_issued_fail <- relocate(ext_issued_fail, V110, .after = V55)
ext_issued_fail <- t(ext_issued_fail)
ext_issued_fail <- as.data.frame(ext_issued_fail)
ext_issued_fail$`repay_fail == "1"` <- as.logical(ext_issued_fail$`repay_fail == "1"`)
ext_issued_fail$n <- as.numeric(ext_issued_fail$n)
issuedfailsumext <- filter(ext_issued_fail, ext_issued_fail$`repay_fail == "1"` == "TRUE")

# Obtain proportion and log(proportion) of failure in each issue_d
prop_issue_d <- issuedfailsumext[,3] / issuedsum[,2]

# Obtain proportion and log(proportion) of failure in each issue_d
prop_issue_d_log <- sapply(prop_issue_d, log)
propissueddf <- data.frame(issue_d = issuedsum$issue_d, frequency = prop_issue_d, log_frequency = prop_issue_d_log )

pissuedfail <- ggplot(propissueddf, aes(x=issue_d, y=frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = propissueddf$issue_d) +
  labs(x = "issue_d",y = "Repay Failure Proportion") +
  theme(axis.text.x = element_text(angle = -90,vjust = 0,hjust = 0))

logpissuedfail <- ggplot(propissueddf, aes(x=issue_d, y=log_frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = propissueddf$issue_d) +
  labs(x = "issue_d",y = "Repay Failure Log(Proportion)") +
  theme(axis.text.x = element_text(angle = -90,vjust = 0,hjust = 0))

pissuedfail ; logpissuedfail
```

```{r exploreext data set zip_code, include=TRUE}
## Plot the proportion and log proportion of failure for zip_code

# Obtain number of people in each zip_code
zipcsum <- count(ext_loan_data, zip_code, .drop = FALSE)

# Obtain number of people that failed in each zip_code
ext_zipc_fail <- count(ext_loan_data, zip_code, repay_fail == "1", .drop = FALSE)
ext_zipc_fail <- filter(ext_zipc_fail, ext_zipc_fail$`repay_fail == "1"` == "TRUE")
ext_zipc_fail$`repay_fail == "1"` <- NULL
ext_zipc_fail2 <- anti_join(zipcsum, ext_zipc_fail, by = c("zip_code" = "zip_code"))
ext_zipc_fail2$n <- 0
ext_zipc_fail <- rbind(ext_zipc_fail, ext_zipc_fail2)
ext_zipc_fail$zip_code <- gsub("xx","",as.character(ext_zipc_fail$zip_code))
ext_zipc_fail <- ext_zipc_fail[order(as.integer(ext_zipc_fail$zip_code),decreasing = FALSE), ]
ext_zipc_fail$zip_code <- paste0(ext_zipc_fail$zip_code, 'xx')

# Obtain proportion and log(proportion) of failure in each zip_code
prop_zip_code <- ext_zipc_fail[,2] / zipcsum[,2]

# Obtain proportion and log(proportion) of failure in each zip_code
prop_zip_code_log <- sapply(prop_zip_code, log)
propzipcdf <- data.frame(zip_code = zipcsum$zip_code, frequency = prop_zip_code, log_frequency = prop_zip_code_log )

pzipcfail <- ggplot(propzipcdf, aes(x=zip_code, y=frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = propzipcdf$zip_code) +
  labs(x = "zip_code",y = "Repay Failure Proportion") 

logpzipcfail <- ggplot(propzipcdf, aes(x=zip_code, y=log_frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = propzipcdf$zip_code) +
  labs(x = "zip_code",y = "Repay Failure Log(Proportion)") 

pzipcfail ; logpzipcfail
```

```{r exploreext data set addr_state, include=TRUE}
## Plot the proportion and log proportion of failure for addr_state

# Obtain number of people in each addr_state
addssum <- count(ext_loan_data, addr_state, .drop = FALSE)

# Obtain number of people that failed in each addr_state
ext_adds_fail <- count(ext_loan_data, addr_state, repay_fail == "1")
ext_missingrowAF <- c("ME", "TRUE", "0")
ext_adds_fail <- rbind(ext_adds_fail, ext_missingrowAF)
ext_adds_fail <- t(ext_adds_fail)
ext_adds_fail <- as.data.frame(ext_adds_fail)
ext_adds_fail <- relocate(ext_adds_fail, V100, .after = V43)
ext_adds_fail <- t(ext_adds_fail)
ext_adds_fail <- as.data.frame(ext_adds_fail)
ext_adds_fail$`repay_fail == "1"` <- as.logical(ext_adds_fail$`repay_fail == "1"`)
ext_adds_fail$n <- as.numeric(ext_adds_fail$n)
addsfailsumext <- filter(ext_adds_fail, ext_adds_fail$`repay_fail == "1"` == "TRUE")

# Obtain proportion and log(proportion) of failure in each addr_state
prop_addr_state <- addsfailsumext[,3] / addssum[,2]

# Obtain proportion and log(proportion) of failure in each addr_state
prop_addr_state_log <- sapply(prop_addr_state, log)
propaddsdf <- data.frame(addr_state = addssum$addr_state, frequency = prop_addr_state, log_frequency = prop_addr_state_log )

paddsfail <- ggplot(propaddsdf, aes(x=addr_state, y=frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = propaddsdf$addr_state) +
  labs(x = "addr_state",y = "Repay Failure Proportion") +
  theme(axis.text.x = element_text(angle = -90,vjust = 0,hjust = 0))

logpaddsfail <- ggplot(propaddsdf, aes(x=addr_state, y=log_frequency)) + 
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_x_discrete(labels = propaddsdf$addr_state) +
  labs(x = "addr_state",y = "Repay Failure Log(Proportion)") +
  theme(axis.text.x = element_text(angle = -90,vjust = 0,hjust = 0))

paddsfail ; logpaddsfail
```
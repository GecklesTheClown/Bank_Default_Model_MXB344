---
title: "Report"
author: "TBD"
date: "`r Sys.Date()`"
output: html_document
---

# Introduction 
Recently our peer-to-peer lending start-up has been acquired by 'Apollo' a regional Australian bank. This acquisition has prompted an investigation into out companies credit risk model. Results of this investigation has concluded that a complete "ground-up' rebuild is necessary. Thus our team's goal in this report is building a statistical model to predict loan default based on information known at the time of application. In regards to this model management have a number of concerns:

1. How does your new model perform compared to the one you used previously? How can it be expected
to perform on new loan applications?

2. What are the important variables in this model? 

3. Can accounting for this variation (e.g., state/zip-code and time) improve performance benchmarks?

4. Are there any surprising differences in variables that are important for predicting credit risk, between
your model with/without location and time information?

5. Does credit risk change over time or between states?
 

# The Data
That data-set we were given is historical lending data from the USA between the years of 2007 to 2011. It features many different data sets which include:

1. All loan data
2. Training data
3. Validation data
4. Extended data

The variables from data-sets (1), (2) & (3) contain these variables.

All Variables:
- "loan_amnt"
- "term"
- "int_rate"
- "emp_length"
- "home_ownership"
- "annual_inc"
- "verification_status"
- "purpose"
- "repay_fail"
- "credit_age_yrs"
- "delinq_2yrs"
- "dti"
- "inq_last_6mths"
- "last_pymnt_amnt"
- "pub_rec"
- "open_acc"
- "total_acc"
- "total_rec_int"
- "total_rec_prncp"
- "revol_bal"
- "revol_util"

but since our model focusing assesing a customer at the time of application we have split our variables into 'applicaple' & "not applicable" 


Applicable:
- "loan_amnt"
- "term"
- "int_rate"
- "emp_length"
- "home_ownership"
- "annual_inc"
- "verification_status"
- "purpose"
- "repay_fail"

Not Applicable.:
- "credit_age_yrs"
- "delinq_2yrs"
- "dti"
- "inq_last_6mths"
- "last_pymnt_amnt"
- "pub_rec"
- "open_acc"
- "total_acc"
- "total_rec_int"
- "total_rec_prncp"
- "revol_bal"
- "revol_util"

The extended data features some new variables different from the other datasets but does still contain all the previous variables.

New Variables:

- "issue_d"
- "zip_code"
- "addr_state"
- "earliest_cr_line"

After this short explanation of the dataset we will do some initial exploration on data set (1,2 & 3).


# Part 1 : Fixed Effects Model 

## Exploration

```{r setup (all_loan_data), include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("./scripts/setup.r")
source(here("scripts","functions.r"))

all_loan_data <- read.csv(file = here::here('datasets', 'all_loan_data.csv')) # Load in the loan data
training_loan_data <- read.csv(file = here::here('datasets', 'training_loan_data.csv')) # Load in the loan data
validation_loan_data <- read.csv(file = here::here('datasets', 'validation_loan_data.csv')) # Load in the loan data

app_cov <- c("loan_amnt","term","int_rate","emp_length","home_ownership","annual_inc","verification_status","purpose","repay_fail")
all_loan_data <- all_loan_data[,app_cov]
all_cat_var <- c("repay_fail",
                 "term",
                 "emp_length",
                 "home_ownership", 
                 "verification_status", 
                 "purpose")

all_loan_data[,all_cat_var] <- lapply(all_loan_data[all_cat_var], factor)
lapply(all_loan_data[all_cat_var],levels) # Make all categorical variables into factors for R 
```

And, load in the extended data.

```{r setup (ext_loan_data)}
extended_loan_data <- read.csv(file = here::here('datasets', 'extended_loan_data.csv')) # Load in the loan data

extended_loan_data[,all_cat_var] <- lapply(extended_loan_data[all_cat_var], factor)
lapply(extended_loan_data[all_cat_var],levels) # Make all categorical variables into factors for R 

ext_loan_data <- extended_loan_data
```

Let's take a look at the data.

```{r summary of chosen variables}
summary(all_loan_data) # Summary of data
```
There are 26071 applicants that did not default their loan payments (repay success, repay_failure = 0) and 4664 applicants that did default their loan payments (repay failure, repay_failure = 1). The overall proportion of applicants, observed in the data provided (all_loan_data), who had to default their loan payments is approximately 17.88961% of applicants. 

There are 4 categorical variables which are term, home_ownership, verification status and purpose. 
The term (loan term) is the set time it takes for a loan to be completely paid off when the borrower is making regular payment. The term in this data set can either be 36 months or 60 months. 22803 applicants have a term of 36 months while 7932 applicants (almost a third of the amount of applicants that have a 36 month term) have a term of 60 months. 
The home_ownership is the home ownership status given by the applicant at the time of application. The home ownership statuses in this data are mortgage, none, other, own (owning a home), rent (renter). There are 13651 applicants who are mortgaging a home, 4 that have not given a home ownership status (none), 101 that are classified as others, 2370 that own a home and 14609 that are renting. Most applicants are either paying a mortgage or renting. 
The verification_status is whether the income of the applicant has been verified by LC (verified), source verified or not verified at all. 13507 applicants have not had their income verified, 7472 have had their income source verified and 9756 have had their income verified by LC.
The purpose is the purpose of the applicant's loan. There are 14 purposes listed in this data set which are "car" (1173 applicants), "credit_card"(3984 applicants), "debt_consolidation"(14339 applicants), "educational"(294 applicants), "home_improvement"(2277 applicants), "house"(308 applicants), "major_purchase"(1636 applicants), "medical"(529 applicants), "moving"(441 applicants), "other"(3205 applicants), "renewable_energy"(70 applicants), "small_business"(1468 applicants), "vacation" (279 applicants) and "wedding"(732 applicants). Almost half of the loan applicants in the data (14339) applicants use their loan for debt consolidation while the number of applicants for the other loan purposes are as follows.

There is one discrete variable, that has been categorized. This discrete variable is employment length. employment lengths are n/a (no employment or employment information not given) (780 applicants), <1 year (3641 applicants), 1 year (2616 applicants), 2 years (3418 applicants), 3 years (3122 applicants), 4 years (2656 applicants), 5 years (2528 applicants), 6 years (1716 applicants), 7 years (1345 applicants), 8 years (1154 applicants), 9 years (965 applicants), 10+ years (6794 applicants). 

There are 3 continuous variables in the data. These are the loan amount given to the applicant (loan_amnt), interest rate on the loan (int_rate) and the annual income at the time of loan application of the applicant (annual_inc). 


We will plot the proportions of repay failure (loan default) against each of our catagorical variables and one discrete variable.

```{r exploratory analysis script}
source(here("scripts","prop_data.r"))
```

Plotted proportions. The first plot is for term, second is for employment length, third is for home ownership, fourth is for verification status and fifth is for loan purpose.

```{r proportion plot for catagorical variables & discrete variable (all_loan_data)}
graph_allptermfail ; graph_allpempfail ; graph_allphomefail ; graph_allpverifail ; graph_allppurpfail 
```
The 60 term has a much higher proportion (~23% having to default payment) of repay failure than that of the 36 month term  (~13% having to default payment)
The total applicants paying mortgage (mortgage), home owners (own) and renters (rent) have around 15-16% applicants that have to default the payment. Whereas, the people who are classified as none and other have around 25-26% of applicant failing to repay their loans on time, which is much higher (by 10%) than that of the other home ownership statuses. There appears to be a trend where people who are paying for their own home, either through mortgage, owning their home or renting a home, have a lower repay failure than that of people who are not paying for their own home, none or other. 
There is a slightly lower proportion (about 14.2-14.3%) of applicants who do not have a verified income having to default their loan payment than that of source verified applicants (about 14.6-14.7%). Verified applicants have the higher proportion of loan default which is about 17%. Overall, there does appear to be a very slight trend with a slightly increase proportion of repay failure.
Loans for small businesses (small_business) have by the highest proportion of repay failure (about 27-29%) by a decent amount. The next higher proportion of repay failure are loans for educational purposes (educational) which is ~20%. Debt consolidation, house, medical, moving, renewable energy, vacation and "other" loan all have similar proportions of repay failure which is between 15% to 17.5%. And, car, credit card, home improvement, major_purchase and wedding loans have similar proportions of repay failure which is between 10% to 12.5%.

The applicants who are not employed or did not provide such information (n/a) have the highest proportions of repay failure at 22.2%. There does not appear to be any trend in the proportion of repay failure of applicants for increasing employment length. 


We plotted the 3 continuous variables against repay failure by making repay failure a categorical variable and the continuous variables the y-axis. Additionally, we tested the 3 continuous variables for co linearity/interactions. We will also be doing an additional plot for only the median and 25-75% of data for annual income due to outliers making it hard to visualize the data. The first plot is for loan amount, second is for interest rate, third and fourth are for annual income (the fourth is the 25%-75% of the data), and the fifth plot is the correlation test (with some information on the distribution of the continuous variables).

```{r continous variables plot and co linearity test (all_loan_data)}

### Make plots for the 3 continuous variables vs repay failure and plots for colinearity

RepayFail_labels <- c("0","1") # Make labels for the box plots with repay failur of the x-axis

#Box plot for loan_amount vs repay_fail
ploanamount <- ggplot(data = all_loan_data,
                      mapping = aes(
                        x = factor(repay_fail),
                        y = loan_amnt,
                      )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Loan_amount")
ploanamount

#Box plot for int_rate vs repay_fail
pinterestrate <- ggplot(data = all_loan_data,
                        mapping = aes(
                          x = factor(repay_fail),
                          y = int_rate,
                        )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Int_rate")
pinterestrate 

#Box plot for annual_inc vs repay_fail
pannualincome <- ggplot(data = all_loan_data,
                        mapping = aes(
                          x = factor(repay_fail),
                          y = annual_inc,
                        )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Annual_inc")
pannualincome

# Box plot for 25-75% of data for annaul inc vs repay fail
ggplot(data = all_loan_data) + stat_summary(
  mapping = aes(x = repay_fail, y = annual_inc),
  fun.min = function(z) { quantile(z,0.25) },
  fun.max = function(z) { quantile(z,0.75) },
  fun = median) +
  labs(x = "Repay Fail",y = "Annual_inc")

# Test for colinarity 
cortest <- ggpairs(all_loan_data, columns = c(1, 3, 6))
cortest
```
Both no repay failure (0) and repay failure (1) have similar loan amounts hence both the loan amounts are equally associated with repay failure and success, i.e. may be the case where 10000-11000 loans have an roughly similar proportion of repay failure to 15000-16000 loans. Whereas, higher interest rates seem to be associated with repay failure more than that of lower interest rates and hence there may be a case where 15%-16% interest rates have a higher proportion of repay failure than that of 10%-11%. It appears that lower annual incomes are more associated with repay failure than that of higher annual income and hence there may be a case were annual income of 50000-60000 have higher proportion of repay failure than that of an annual income of 500000-501000. We can also see that the outiliers, mostly a result of people with extremely higher annual income as shown by the plot, in the annual income plot has a significant affect on the distribution of the data. Additionally there is a right skew with interest rate and loan amount. Furthermore, there is a heavy right skew on the annual income. 

The loan amount has a positive correlation with interest rate and annual income while interest rate and annual income has a low positive correlation. The correlation between loan amount and interest rate is 0.29 which is high enough to consider that there is an interaction between interest rate and loan amount. The correlation between loan amount and annual income (0.342), which is high enough to consider that there is an interaction between annual income and loan amount, also the correlation is slightly higher than that of the correlation between loan amount and interest rate. In conclusion there is a moderate interaction, which can affect the model, between loan amount and interest rate and between loan amount and annual income while there is a slight interaction, not enought to affect the model in a meaningful way, between interest rate and annual income. 


We done violin plots between our discrete variable (employment length) and the three continuous variables to examine the relationship between the discrete predictor and the different continuous predictors. First plot is for loan amount, second plot is for interest rate and third plot is for annual income.

```{r relationship between discrete variable and the continous variables (all_loan_data)}
## Kernal/Violin plots of emp_lenth vs 3 continuous variables in all_loan_data

# Kernal/Violin plot of emp_length vs loan_amnt
tmp <- melt(all_loan_data[, c("emp_length", "loan_amnt")], id.vars="emp_length")
ggplot(tmp, aes(x = emp_length, y = value)) +
  geom_jitter(alpha = .1) +
  geom_violin(alpha = .75) +
  facet_grid(variable ~ .) #+
#scale_y_sqrt()

# Kernal/Violin plot of emp_length vs int_rate
tmp <- melt(all_loan_data[, c("emp_length", "int_rate")], id.vars="emp_length")
ggplot(tmp, aes(x = emp_length, y = value)) +
  geom_jitter(alpha = .1) +
  geom_violin(alpha = .75) +
  facet_grid(variable ~ .) #+
#scale_y_sqrt()

# Kernal/Violin plot of emp_length vs annual_inc
tmp <- melt(all_loan_data[, c("emp_length", "annual_inc")], id.vars="emp_length")
ggplot(tmp, aes(x = emp_length, y = value)) +
  geom_jitter(alpha = .1) +
  geom_violin(alpha = .75) +
  facet_grid(variable ~ .) #+
#scale_y_sqrt()
```
The distribution of loan amount for each employment length is slightly right skewed. The distributions appear to become slightly less skewed for increasing employment length however this is a small difference and is not significant enough to consider that employment length has an interaction with loan_amount. There appear to be no trend of the distributions of annual income and interest rate with increasing employment length for the other two plots. Interactions that can affect the model between employment length and the three other continuous variables does not exist. 


We then sorted the continuous variables in 20 groups. Then we found the logit of the proportions for of repay failure of each group and plotted them to determine if the logit of the proportion of repay failure had a linear relationship with the continuous variables. If so then then a logistic regression can be used to fit for the data (that contains binary outcomes) since one of the assumptions of logistic regression is that the logit of the proportion of observations has a linear relationship with the continuous variables. The logit is log(y/(1-y)). First plot is for loan amount, second plot is for interest rate, and third plot is for annual income.

```{r logit proportion of repay failure vs the continous variables (all_loan_data)}
### Do logistic exploration for all_loan_data
## Explore relationship between log(p/(1-p)) for loan_amnt
xa1 <- all_loan_data$loan_amnt
ya <- all_loan_data$repay_fail
ya <- as.integer(ya)
ya[ya == 1] <- 0
ya[ya == 2] <- 1
gala <- cut(xa1, breaks=quantile(xa1,seq(0,100,5)/100))
yamla <- tapply(ya, gala, mean)
xamla <- tapply(xa1, gala, mean)
yampla <- log(yamla/(1-yamla))
plot(xamla,yampla,xlab="Loan_amnt",ylab="Logit of Proportion of Repay Failure")

## Explore relationship between log(p/(1-p)) for int_rate
xa2 <- all_loan_data$int_rate
gair <- cut(xa2, breaks=quantile(xa2,seq(0,100,5)/100))
yamir <- tapply(ya, gair, mean)
xamir <- tapply(xa2, gair, mean)
yampir <- log(yamir/(1-yamir))
plot(xamir,yampir,xlab="Int_rate",ylab="Logit of Proportion of Repay Failure")

## Explore relationship between log(p/(1-p)) for annual_inc
xa3 <- all_loan_data$annual_inc
gaai <- cut(xa3, breaks=quantile(xa3,seq(0,100,5)/100))
yamai <- tapply(ya, gaai, mean)
xamai <- tapply(xa3, gaai, mean)
yampai <- log(yamai/(1-yamai))
plot(xamai,yampai,xlab="Annual_inc",ylab="Logit of Proportion of Repay Failure")
```
We can see that there is a rough positive linear relationship between the logit of proportion of repay failure and loan amount. We can also see that there is a strong positive linear relationship between the logit of proportion of repay failure and interest rate. We can also see that there is a moderate negative linear relationship between the logit of proportion of repay failure and annual income. However this could be a quadratic relationship for the annual income with the logit of proportion of repay failure as shown by the logit of the last and second last groups going back up but there is not enough data points in between the last group and the second last group to determine if this is the case. In conclusion we can suggest using a logistic regression to fit the data provided since the assumption of linearity of logit observations vs continuous predictors is met. 


## Model Building

Let's try our hand a creating a model based on our own beliefs from research and exploration 

### Initial Model 

```{r}
m.initial <- glm(formula = repay_fail ~ 
               term + 
               purpose +                                
               verification_status +  
               annual_inc,
              data = all_loan_data,
              family = binomial(link = "logit"))

roc.glm(m.initial)

```

This is good but let's see if stepwise can make it better.

### Stepwise Model 

```{r M-Build}

#Full model with all possible covariates (one-way)

full_interaction_model <- glm(data = all_loan_data,
                              formula = repay_fail ~.,
                              family = binomial(link = "logit"))

#Full model with all possible covariates (two-way)

full_interaction_model_P2W <- glm(data = all_loan_data,
                              formula = repay_fail ~.
                              + annual_inc*int_rate,
                              family = binomial(link = "logit"))

#Model with no covariates present

null_model <- glm(data = all_loan_data,
                  formula = repay_fail ~ 1,
                  family = binomial(link = "logit"))


#Perform backward and forward selection:
backward_sel_model <- stepAIC(full_interaction_model, 
                              direction = "backward",
                              trace = 0) 

forward_sel_model <- stepAIC(null_model, 
                             scope = formula(full_interaction_model), 
                             direction = "forward", trace = 0)

both_sel_model <- stepAIC(full_interaction_model, 
                              direction = "both",
                              trace = 0) 

both_sel_model_P2W <- stepAIC(full_interaction_model_P2W, 
                              direction = "both",
                              trace = 0)

forward_sel_model_P2W  <- stepAIC(null_model, 
                             scope=formula(full_interaction_model_P2W),
                             direction = "forward", trace = 0)

model.list <- list(
  "backward 1W" = backward_sel_model,
  "Forward 1W" = forward_sel_model,
  "Both 1W" = both_sel_model,
  "Both P2W" = both_sel_model_P2W,
  "Forward P2W" = forward_sel_model_P2W)

bics <- sapply(model.list,FUN = BIC)

plot_data <- 
  data.frame(
    model = c("backward 1W","Forward 1W","Both 1W","Both P2W","Forward P2W"),
    bic = bics)

#Display table with measures:
knitr::kable(plot_data,row.names = FALSE,
             col.names = c("Model","BIC"))

```


## Model Selection
```{r, model-per message=FALSE, cache=TRUE}

roc(both_sel_model)
plot_summs(both_sel_model, ci_level = 0.95)

# acc.perf = performance(pred, measure = "acc")
# plot(acc.perf)
# acc.perf_vali = performance(pred_vali, measure = "acc")
# plot(acc.perf_vali)
# ind = which.max( slot(acc.perf, "y.values")[[1]] )
# acc = slot(acc.perf, "y.values")[[1]][ind]
# cutoff = slot(acc.perf, "x.values")[[1]][ind]
# print(c(accuracy= acc, cutoff = cutoff))
# 
# # Creating a confusion matrix
# confusionMatrix(training_loan_data$repay_fail,pred_value_labels)

```

Since M2 is nested inside M4 these two models can be compared using a $\chi^2$-test, with hypotheses:

- H0: Additional parameter season is not needed to explain variation
- H1: Additional parameter season is needed to explain variation

```{r, model-per message=FALSE, cache=TRUE}
nested1 <- glm(formula = repay_fail ~
                int_rate + 
                term + 
                emp_length + 
                purpose + 
                verification_status + 
                annual_inc,
                data = all_loan_data,
              family = binomial)

anova(nested1,forward_sel_model, test="Chisq")

BIC(nested1); BIC(forward_sel_model)

nested2 <- glm(formula = repay_fail ~
                int_rate + 
                term + 
                purpose + 
                verification_status + 
                annual_inc,
                data = all_loan_data,
              family = binomial)

anova(nested1,nested2, test="Chisq")



```

```{r}
roc(nested1)
plot_summs(nested1, ci_level = 0.95)

```

```{r}
test <- glm(formula = repay_fail ~
             int_rate + 
             term + 
             emp_length + 
             purpose + 
             verification_status + 
             home_ownership + 
             annual_inc +
              annual_inc*int_rate,
                  data = all_loan_data,
                  family = binomial)

roc.glm(test)
summary(test)
test <- glm(formula = repay_fail ~
             int_rate + 
             term + 
             emp_length + 
             purpose + 
             verification_status + 
             home_ownership + 
             annual_inc +
              annual_inc*int_rate+loan_amnt*annual_inc,
                  data = all_loan_data,
                  family = binomial)

roc.glm(test)
summary(test)
test <- glm(formula = repay_fail ~
             int_rate + 
             term + 
             emp_length + 
             purpose + 
             verification_status + 
             home_ownership + 
             annual_inc +
              annual_inc*int_rate+loan_amnt*int_rate+loan_amnt*annual_inc,
                  data = all_loan_data,
                  family = binomial)

roc.glm(test)
summary(test)
final_glm <- glm(formula = repay_fail ~
             int_rate + 
             term + 
             emp_length + 
             purpose + 
             verification_status + 
             home_ownership + 
             annual_inc +
              annual_inc*int_rate+loan_amnt*int_rate,
                  data = all_loan_data,
                  family = binomial)

roc.glm(final_glm)
summary(final_glm)

```

As stated previously our exploratory analysis found that they were some colinaeraity with annual income , interest rate and loan amount as such we created a models with an interaction term between those three  variables and assessed which produced the best AUC values. From the various models we found that our final model with all variables (excluding loan amount) and the interation term between annual income and interest rate and loan amount and interest rate.
```{r}
simulationOutput <- simulateResiduals(fittedModel = final_glm)
plot(simulationOutput)
plotResiduals(simulationOutput, all_loan_data$int_rate, quantreg = T)
par(mfrow = c(1,2))
testDispersion(simulationOutput)
simulationOutput = recalculateResiduals(simulationOutput , group = all_loan_data$group)
testDispersion(simulationOutput)
plotResiduals(simulationOutput)
```

## Model Evaluation
```{r}
summary(final_glm)
plot_summs(final_glm)
confint(final_glm)
exp(cbind(OR = coef(final_glm), confint(final_glm)))

```
As a result of having so more many variable that need to assessed we are primarily going to interpret the covariate that are statistically significant .
Interest Rate(highly significant): For a one unit increase in interest rate, the odds of failing to pay your debt (versus not failing to pay your debt ) increase by a factor of 1.14
Term60 months (highly significant):Having a loan term of 60 months, versus a loan term of 30 months, changes  the odds of repay failure by a factor of 1.19
Employment 10+ years (mildly significant):Having a employment length of 10+ years, versus a employment length of less than 1 year, changes the odds of repay failure by a factor of 1.41
purposedebt_consolidation(significant):Having  the purpose of incurring debt being debt consolidation versus the purpose being purchasing a car, changes the odds of repay failure by a factor of 1.23
purpose educational (highly significant):Having  the purpose of incurring debt being educational versus the purpose being purchasing a car, changes the odds of repay failure by a factor of 1.82
purposehouse (significant):Having  the purpose of incurring debt being purchasing a house versus the purpose being purchasing a car, changes the odds of repay failure by a factor of 1.44
purposemedical(highly significant):Having  the purpose of incurring debt being medical versus the purpose being purchasing a car, changes the odds of repay failure by a factor of 1.67
purposemoving(mildly significant):Having  the purpose of incurring debt being moving verus the purpose being purchasing a car, changes the odds of repay failure by a factor of 1.61
purposeother (highly significant):Having  the purpose of incurring debt being other versus the purpose being purchasing a car, changes the odds of repay failure by a factor of 1.54
purposesmall_business(high significant):Having  the purpose of incurring debt being small busniess the purpose being purchasing a car, changes the odds of repay failure by a factor of 2.71
purposevacation(significant):Having  the purpose of incurring debt being vacation versus the purpose being purchasing a car, changes the odds of repay failure by a factor of 1.48
verification_statusSource Verified(mildly significant):Having  the verification status being source verified versus the the verificantion status being not verified, changes the odds of repay failure by a factor of 0.88
home_ownershipOTHER(mildly siginificant)Having  the home ownership status being other versus home ownership status being mortgage t, changes the odds of repay failure by a factor of 1.99
annual income(highly significant): For a one unit increase in annual income, the odds of failing to pay your debt (versus not failing to pay your debt ) decrease by a factor of 0.99
# Part 2: Mixed Effects Model

## Exploration
We have been provided with an extended data set that contains our random effects (we will only consider 2 of them for model fitting). We will do a separate exploratory analysis for the extended data set due to it having 38419 applicants while the normal data set has 30735. Thus there could be changes to the relationships and observations made in the previous exploratory analysis for the normal data set (without the random effects)

Plotted the proportions of repay failure against our 4 categorical variables and 1 of our discrete variables (that has been categorized). The first plot is for term, second is for employment length, third is for home ownership, fourth is for verification status and fifth is for loan purpose.

```{r proportion plot for catagorical variables & discrete variable (ext_loan_data)}
graph_extptermfail ; graph_extpempfail ; graph_extphomefail ; graph_extpverifail ; graph_extppurpfail 
```
The proportions of repay failure is higher for the applicants that have a 60 month term (~23%-24% repay failure) than that of the 36 months (~12%-13% repay failure).
The repay failure proportions for home ownership statuses classified as none (25%) or other (~23%) is much higher than that of the other proportions. Home ownership statuses classified as mortgage (~14-14.5%%), own (~15.5%) and rent (~16%) have similar proportions of repay failure.
There appears to be a slight trend with the proportion of repay failure in the verification status where the more verified an applicant is the higher the proportion of repay failure is (~14% for not verified, ~14.75% with source verified and ~ 16.75% with verified).
The small business loan have the highest proportion of repay failure which is ~27.5%. The educational loan have the next highest proportion of loan default which is ~21%-22%. Dept consolidation, house, medical, moving, other, renewable energy, and vacation loans have similar proportions of repay failure at around 15%-17.5%. Car, credit card, home improvement, major purchase and wedding have similar proportions of repay failure at `around ~10%-12.5%. 

Employment length classified as n/a has the highest proportion of repay failure which is at ~22-22.5%. There does not appear to be a trend in the increasing employment length and proportion of repay failure. 


We plotted the 3 continuous variables against repay failure by making repay failure a categorical variable and the continuous variables the y-axis. And, we tested the 3 continuous variables for co linearity. We will also be doing an additional plot for only the median and 25-75% of data for annual income due to outliers making it hard to visualize the data. The first plot is for loan amount, second is for interest rate, third and fourth are for annual income (the fourth is the 25%-75% of the data), and the fifth plot is the correlation test (with some information on the distribution of the continuous variables).

```{r continous variables plot and co linearity test (ext_loan_data)}

### Make plots for the 3 continuous variables vs repay failure and plots for colinearity

RepayFail_labels <- c("0","1") # Make labels for the box plots with repay failur of the x-axis

#Box plot for loan_amount vs repay_fail
ploanamount <- ggplot(data = ext_loan_data,
                      mapping = aes(
                                   x = factor(repay_fail),
                                   y = loan_amnt,
       )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Loan_amount")
ploanamount

#Box plot for int_rate vs repay_fail
pinterestrate <- ggplot(data = ext_loan_data,
       mapping = aes(
         x = factor(repay_fail),
         y = int_rate,
       )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Int_rate")
pinterestrate 

#Box plot for annual_inc vs repay_fail
pannualincome <- ggplot(data = ext_loan_data,
       mapping = aes(
         x = factor(repay_fail),
         y = annual_inc,
       )) +
  geom_boxplot() +
  scale_x_discrete(labels = RepayFail_labels)+
  theme(axis.text.x = element_text(angle = -45,vjust = 0,hjust = 0)) +
  labs(x = "Repay Fail",y = "Annual_inc")
pannualincome

# Box plot for 25-75% of data for annual inc vs repay fail
ggplot(data = ext_loan_data) + stat_summary(
  mapping = aes(x = repay_fail, y = annual_inc),
  fun.min = function(z) { quantile(z,0.25) },
  fun.max = function(z) { quantile(z,0.75) },
  fun = median) +
  labs(x = "Repay Fail",y = "Annual_inc")

# Test for colinarity 
cortest <- ggpairs(ext_loan_data, columns = c(2, 4, 7))
cortest
```
Just like in the previous data set, both no repay failure (0) and repay failure (1) have similar loan amounts hence both the loan amounts are equally associated with repay failure and success, i.e. may be the case where 10000-11000 loans have an roughly similar proportion of repay failure to 15000-16000 loans. Whereas, higher interest rates seem to be associated with repay failure more than that of lower interest rates and hence there may be a case where 15%-16% interest rates have a higher proportion of repay failure than that of 10%-11%. It appears that lower annual incomes are more associated with repay failure than that of higher annual income and hence there may be a case were annual income of 50000-60000 have higher proportion of repay failure than that of an annual income of 500000-501000. We can also see that the outiliers, mostly a result of people with extremely higher annual income as shown by the plot, in the annual income plot has a still has a significant affect on the distribution of the data. Additionally there is a right skew with interest rate and loan amount. Furthermore, there is a heavy right skew on the annual income.  

Just like in the previous data set, the loan amount has a positive correlation with interest rate and annual income while interest rate and annual income has a low positive correlation. The correlation between loan amount and interest rate is 0.292 which is high enough to consider that there is an interaction between interest rate and loan amount. The correlation between loan amount and annual income (0.277), which is high enough to consider that there is an interaction between annual income and loan amount, also the correlation is slightly lower than that of the correlation between loan amount and interest rate. In conclusion there is a moderate interaction, which can affect the model, between loan amount and interest rate and between loan amount and annual income while there is a slight interaction, which will only have very minor effects on the model, between interest rate and annual income. 

We plotted violin plots between our discrete variable (employment length) and the three continuous variables to examine the relationship between the discrete predictor and the different continuous predictors. First plot is for loan amount, second plot is for interest rate and third plot is for annual income.

```{r relationship between discrete variable and the continous variables (ext_loan_data)}
## Kernal/Violin plots of emp_lenth vs 3 continuous variables in all_loan_data

# Kernal/Violin plot of emp_length vs loan_amnt
tmp <- melt(all_loan_data[, c("emp_length", "loan_amnt")], id.vars="emp_length")
ggplot(tmp, aes(x = emp_length, y = value)) +
  geom_jitter(alpha = .1) +
  geom_violin(alpha = .75) +
  facet_grid(variable ~ .) #+
#scale_y_sqrt()

# Kernal/Violin plot of emp_length vs int_rate
tmp <- melt(all_loan_data[, c("emp_length", "int_rate")], id.vars="emp_length")
ggplot(tmp, aes(x = emp_length, y = value)) +
  geom_jitter(alpha = .1) +
  geom_violin(alpha = .75) +
  facet_grid(variable ~ .) #+
#scale_y_sqrt()

# Kernal/Violin plot of emp_length vs annual_inc
tmp <- melt(all_loan_data[, c("emp_length", "annual_inc")], id.vars="emp_length")
ggplot(tmp, aes(x = emp_length, y = value)) +
  geom_jitter(alpha = .1) +
  geom_violin(alpha = .75) +
  facet_grid(variable ~ .) #+
#scale_y_sqrt()
```
Just like in the previous data set, the distribution of loan amount for each employment length is slightly right skewed. The distributions appear to become slightly less skewed for increasing employment length however this is a small difference and is not significant enough to consider that employment length has an interaction with loan_amount. There appear to be no trend of the distributions of annual income and interest rate with increasing employment length for the other two plots. Interactions that can affect the model between employment length and the three other continuous variables does not exist. 


Just like in the previous data set, we then sorted the continuous variables in 20 groups. Then we found the logit of the proportions for of repay failure of each group and plotted them to determine if the logit of the proportion of repay failure had a linear relationship with the continuous variables. If so then then a logistic regression can be used to fit for the data (that contains binary outcomes) since one of the assumptions of logistic regression is that the logit of the proportion of observations has a linear relationship with the continuous variables. The logit is log(y/(1-y)). First plot is for loan amount, second plot is for interest rate, and third plot is for annual income.

```{r logit proportion of repay failure vs the continous variables (ext_loan_data)}
### Do logistic exploration for all_loan_data
## Explore relationship between log(p/(1-p)) for loan_amnt
x1 <- ext_loan_data$loan_amnt
y <- ext_loan_data$repay_fail
y <- as.integer(y)
y[y == 1] <- 0
y[y == 2] <- 1
gla <- cut(x1, breaks=quantile(x1,seq(0,100,5)/100))
ymla <- tapply(y, gla, mean)
xmla <- tapply(x1, gla, mean)
ympla <- log(ymla/(1-ymla))
plot(xmla,ympla,xlab="Loan_amnt",ylab="Logit of Proportion of Repay Failure")

## Explore relationship between log(p/(1-p)) for int_rate
x2 <- ext_loan_data$int_rate
gir <- cut(x2, breaks=quantile(x2,seq(0,100,5)/100))
ymir <- tapply(y, gir, mean)
xmir <- tapply(x2, gir, mean)
ympir <- log(ymir/(1-ymir))
plot(xmir,ympir,xlab="Int_rate",ylab="Logit of Proportion of Repay Failure")

## Explore relationship between log(p/(1-p)) for annual_inc
x3 <- ext_loan_data$annual_inc
gai <- cut(x3, breaks=quantile(x3,seq(0,100,5)/100))
ymai <- tapply(y, gai, mean)
xmai <- tapply(x3, gai, mean)
ympai <- log(ymai/(1-ymai))
plot(xmai,ympai,xlab="Annual_inc",ylab="Logit of Proportion of Repay Failure")
```
Just like in the previous data set, we can see that there is a rough positive linear relationship between the logit of proportion of repay failure and loan amount. We can also see that there is a strong positive linear relationship between the logit of proportion of repay failure and interest rate. We can also see that there is a moderate negative linear relationship between the logit of proportion of repay failure and annual income. However this could be a quadratic relationship for the annual income with the logit of proportion of repay failure as shown by the logit of the last and second last groups going back up but there is not enough data points in between the last group and the second last group to determine if this is the case. In conclusion we can suggest using a logistic regression to fit the data provided since the assumption of linearity of logit observations vs continuous predictors is met. 


We then plotted the proportion of failure for our random effects to determine if the proportions differ within each location (address state and zip code) and if the proportions differ with time (issue date of loan and earliest credit line). We did plots for address state (addr_state) as the location random effect and issue date of loan (issue_d) as the time random effect since they have a decent amount of data points for each time/location, which we can briefly explore its effects on the linearity assumption of the logistic regression model. 

Here are the plots. The first plot is for issue date and second plot is for address state.

```{r proprtion of repyay failure vs random effects (ext_loan_data)}
pissuedfail ; paddsfail
```
We can see that the proportion of repay failure differs significantly for each time (issue date of loan) and for each location (address state). We can see particular that address state "ME" has 0% repay failure and address states "IN" (~36%-38% repay failure) and "NE" (~50% repay failure) have by far the highest proportion of repay failures. We can see that there are no repay failure in June 2007. Therefore, we should consider accounting for the time (issue date) and location (address state) in our model. Therefore we will use a generalized linear mixed effects model for our final model since the random effects does effect our proportion of repay failure. Furthermore, this answer one you the inquired which is, "Does credit risk change over time or between states?", which indeed credit risk (proportion of repay failure) does change between issue date and address states. 


We then plotted the logit of the proportion of repay failure against each of the continuous variables, which have been further categorized into address state (the location random effect). This was done to see if address state had an effect on the linear assumption of the logit of proportion of repay failure. We have not done this for all address states as for some address states there is not enough data to effectively do this. The rule of thumb was that a address state had to have at least 100 applicants to do this graph for. The rule of thumb was that a issue date had to have at least 150 applicants to do this graph for. 

Here are these plots for the loan amount vs logit of proportion of repay failure for each address state. The address states that were not able to be plotted like this are AK, IA, ID, IN, ME, MS, MT, NE, SD, TN, VT and WY. 

```{r logit of proportion of repay failure vs loan amount for each address state (ext_loan_data)}

# Create new set of address states that we can do these plots for
new_addssum <- addssum[-c(1, 13, 14, 16, 22, 26, 27, 29, 41, 42, 46, 50), ]

# Plot the logit of failure for loan_amnt variable for first 9 addr_state
par(mfrow=c(3,3))
for(i in 1:38){
  ads <- which(ext_loan_data$addr_state == new_addssum[i,1])
  xamnads <- ext_loan_data$loan_amnt[ads]
  yads <- ext_loan_data$repay_fail[ads]
  yads <- as.integer(yads)
  yads[yads == 1] <- 0
  yads[yads == 2] <- 1
  gamnads <- cut(xamnads, breaks=quantile(xamnads,seq(0,100,20)/100))
  ymamnads <- tapply(yads, gamnads, mean)
  xmamnads <- tapply(xamnads, gamnads, mean)
  ympamnads <- logit(ymamnads/(1-ymamnads))
  plot(xmamnads,ympamnads,main=paste("addr_state = ",addssum[i,1]),xlab="Loan_amnt",ylab="Logit(Proportion)")
}
```
We can see that there still exists a rough positive linear relationship between the logit of the repay failure and loan amount for most of the address states. Additionally, the logit of the proportion of repay failure are different for each state which shows that address state has an effect on the proportion of repay failure. 

Here are these plots for the interest rate vs logit of proportion of repay failure for each address state.

```{r logit of proportion of repay failure vs interest rate for each address state (ext_loan_data)}

# Create new set of address states that we can do these plots for
new_addssum <- addssum[-c(1, 13, 14, 16, 22, 26, 27, 29, 41, 42, 46, 50), ]

# Plot the logit of failure for each int_rate variable for addr_state
par(mfrow=c(3,3))
for(i in 1:38){
  ads <- which(ext_loan_data$addr_state == new_addssum[i,1])
  xinrads <- ext_loan_data$int_rate[ads]
  yads <- ext_loan_data$repay_fail[ads]
  yads <- as.integer(yads)
  yads[yads == 1] <- 0
  yads[yads == 2] <- 1
  ginrads <- cut(xinrads, breaks=quantile(xinrads,seq(0,100,15)/100))
  yminrads <- tapply(yads, ginrads, mean)
  xminrads <- tapply(xinrads, ginrads, mean)
  ympinrads <- logit(yminrads/(1-yminrads))
  plot(xminrads,ympinrads,main=paste("addr_state = ",addssum[i,1]),xlab="Int_rate",ylab="Logit(Proportion)")
}
```
We can see that there still exists a strong positive linear relationship between the logit of the repay failure and interest rate for most of the address states. Additionally, the logit of the proportion of repay failure are different for each state which also shows that address state has an effect on the proportion of repay failure. 

Here are these plots for the annual income vs logit of proportion of repay failure for each address state.

```{r logit of proportion of repay failure vs annual income for each address state (ext_loan_data)}

# Create new set of address states that we can do these plots for
new_addssum <- addssum[-c(1, 13, 14, 16, 22, 26, 27, 29, 41, 42, 46, 50), ]

# Plot the logit of failure for each annual_inc variable for addr_state
par(mfrow=c(3,3))
for(i in 1:38){
  ads <- which(ext_loan_data$addr_state == new_addssum[i,1])
  xaniads <- ext_loan_data$annual_inc[ads]
  yads <- ext_loan_data$repay_fail[ads]
  yads <- as.integer(yads)
  yads[yads == 1] <- 0
  yads[yads == 2] <- 1
  ganiads <- cut(xaniads, breaks=quantile(xaniads,seq(0,100,15)/100))
  ymaniads <- tapply(yads, ganiads, mean)
  xmaniads <- tapply(xaniads, ganiads, mean)
  ympaniads <- logit(ymaniads/(1-ymaniads))
  plot(xmaniads,ympaniads,main=paste("addr_state = ",addssum[i,1]),xlab="annual_inc",ylab="Logit(Proportion)")
}
```
We can see that there still exists a moderate negative linear relationship between the logit of the repay failure and annual income for most of the address states. Additionally, the logit of the proportion of repay failure are different for each state which also shows that address state has an effect on the proportion of repay failure. 


Here are the plots for the loan amount vs logit of proportion of repay failure for each issue date. The issue dates that were not able to be plotted like this are Aug-2007, Aug-2008, Jul-2007, Jul-2008, Jun-2007, Jun-2008, May-2008, Nov-2007, Oct-2007, Oct-2008, Sept-2007, Sept-2008.

```{r logit of proportion of repay failure vs loan amount for each issue date (ext_loan_data)}

# Create new set of address states that we can do these plots for
new_issuedsum <- issuedsum[-c(5, 6, 23, 24, 28, 29, 37, 41, 46, 47, 51, 52), ]

# Plot the logit of failure for each loan_amnt variable for issue_d
par(mfrow=c(3,3))
for(i in 1:43){
  isd <- which(ext_loan_data$issue_d == new_issuedsum[i,1])
  xamnisd <- ext_loan_data$loan_amnt[isd]
  yisd <- ext_loan_data$repay_fail[isd]
  yisd <- as.integer(yisd)
  yisd[yisd == 1] <- 0
  yisd[yisd == 2] <- 1
  gamnisd <- cut(xamnisd, breaks=quantile(xamnisd,seq(0,100,20)/100))
  ymamnisd <- tapply(yisd, gamnisd, mean)
  xmamnisd <- tapply(xamnisd, gamnisd, mean)
  ympamnisd <- log(ymamnisd/(1-ymamnisd))
  plot(xmamnisd,ympamnisd,main=paste("issue_d = ",issuedsum[i,1]),xlab="Loan_amnt",ylab="Logit(Proportion)")
}
```
We can see that there still exists a rough positive linear relationship between the logit of the repay failure and loan amount for most of the issue dates. Additionally, the logit of the proportion of repay failure are different for each issue date which shows that issue date has an effect on the proportion of repay failure. 

Here are the plots for the interest rate vs logit of proportion of repay failure for each issue date. 

```{r logit of proportion of repay failure vs interest rate for each issue date (ext_loan_data)}

# Create new set of address states that we can do these plots for
new_issuedsum <- issuedsum[-c(5, 6, 23, 24, 28, 29, 37, 41, 46, 47, 51, 52), ]

# Plot the logit of failure for each int_rate variable for issue_d
par(mfrow=c(3,3))
for(i in 1:43){
  isd <- which(ext_loan_data$issue_d == new_issuedsum[i,1])
  xinrisd <- ext_loan_data$int_rate[isd]
  yisd <- ext_loan_data$repay_fail[isd]
  yisd <- as.integer(yisd)
  yisd[yisd == 1] <- 0
  yisd[yisd == 2] <- 1
  ginrisd <- cut(xinrisd, breaks=quantile(xinrisd,seq(0,100,20)/100))
  yminrisd <- tapply(yisd, ginrisd, mean)
  xminrisd <- tapply(xinrisd, ginrisd, mean)
  ympinrisd <- log(yminrisd/(1-yminrisd))
  plot(xminrisd,ympinrisd,main=paste("issue_d = ",issuedsum[i,1]),xlab="Int_rate",ylab="Logit(Proportion)")
}
```
We can see that there still exists a strong positive linear relationship between the logit of the repay failure and interest rate for most of the issue dates. Additionally, the logit of the proportion of repay failure are different for each issue date which also shows that issue date has an effect on the proportion of repay failure. 

Here are the plots for the annual income vs logit of proportion of repay failure for each issue date. 

```{r logit of proportion of repay failure vs annual income for each issue date (ext_loan_data)}

# Create new set of address states that we can do these plots for
new_issuedsum <- issuedsum[-c(5, 6, 23, 24, 28, 29, 37, 41, 46, 47, 51, 52), ]

# Plot the logit of failure for each annual_inc variable for issue_d
par(mfrow=c(3,3))
for(i in 1:43){
  isd <- which(ext_loan_data$issue_d == new_issuedsum[i,1])
  xaniisd <- ext_loan_data$annual_inc[isd]
  yisd <- ext_loan_data$repay_fail[isd]
  yisd <- ext_loan_data$repay_fail[isd]
  yisd <- as.integer(yisd)
  yisd[yisd == 1] <- 0
  yisd[yisd == 2] <- 1
  ganiisd <- cut(xaniisd, breaks=quantile(xaniisd,seq(0,100,20)/100))
  ymaniisd <- tapply(yisd, ganiisd, mean)
  xmaniisd <- tapply(xaniisd, ganiisd, mean)
  ympaniisd <- log(ymaniisd/(1-ymaniisd))
  plot(xmaniisd,ympaniisd,main=paste("issue_d = ",issuedsum[i,1]),xlab="Annual_inc",ylab="Logit(Proportion)")
}
```
We can see that there still exists a moderate negative linear relationship between the logit of the repay failure and annual income for most of the issue dates. Additionally, the logit of the proportion of repay failure are different for each issue date which also shows that issue date has an effect on the proportion of repay failure. 

In conclusion we will still consider doing a logistic regression when accounting for the time and location random effects. Thus, we will consider doing a logistic regression for the generalized linear mixed effects model (GLMM) as hour final model.


## Model Building 

```{r, Mixed Effect model message=FALSE, cache=TRUE}

# Scale the continious variables
cont_var <- c("int_rate","annual_inc")
unscaled_var <- extended_loan_data[,cont_var]
extended_loan_data[,cont_var] <- scale(extended_loan_data[,cont_var])
sds <- lapply(unscaled_var, sd)



# Create Initial GLMM

m <- glmer(repay_fail ~
             int_rate + 
             term + 
             emp_length + 
             purpose + 
             verification_status + 
             home_ownership + 
             annual_inc +  
             (1 |addr_state) + 
             (1|issue_d), 
           data = extended_loan_data, 
           family = binomial,
           control=glmerControl(optimizer = "bobyqa",optCtrl=list(maxfun=1e6)))

#Glmm with interaction term
m2 <- glmer(repay_fail ~
             int_rate + 
             term + 
             emp_length + 
             purpose + 
             verification_status + 
             home_ownership + 
             annual_inc + annual_inc*int_rate+ 
             (1 |addr_state) + 
             (1|issue_d), 
           data = extended_loan_data, 
           family = binomial,
           control=glmerControl(optimizer = "bobyqa",optCtrl=list(maxfun=1e6)))

```

```{r, Assessing MEM message=FALSE, cache=TRUE}

summary(m2)
predicted_values.m <- predict(m2, type = 'response', newdata = extended_loan_data)
pred_m.mem<- prediction(predicted_values.m, extended_loan_data$repay_fail)
roc.perf = performance(pred_m.mem, measure = "tpr", x.measure = "fpr")

plot(roc.perf)
abline(a=0, b= 1)
auc.perf = performance(pred_m.mem, measure = "auc")
auc.perf@y.values

roc.glmm(m2)

plot_summs(forward_sel_model,m2, rescale.distributions = TRUE)

```

```{r}
se.ranef(m)
ranef(m)
confint(m)
```
## Interperation of our Model Coefficents

## Our Actual Best GLM (with interaction term)

```{r}
test <- glm(formula = repay_fail ~
             int_rate + 
             term + 
             emp_length + 
             purpose + 
             verification_status + 
             home_ownership + 
             annual_inc + 
              annual_inc*int_rate,
                  data = all_loan_data,
                  family = binomial)

roc.glm(test)

```


